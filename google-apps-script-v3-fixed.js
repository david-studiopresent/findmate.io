/**
 * JAV√çTOTT GOOGLE APPS SCRIPT FOR FINDMATE WAITLIST - V3
 *
 * Ez a verzi√≥ jav√≠tja a "Cannot read properties of undefined" hib√°t
 */

// FONTOS: Ellen≈ërizd ezt a Sheet ID-t!
const CONFIG = {
  SHEET_ID: '1Vn2qGy5C8K63FPmGGJsoP9HvFuss3EbEQW2Qu877C9M',
  SHEET_NAME: 'WaitList'
};

/**
 * ELS≈ê L√âP√âS: Futtasd ezt a funkci√≥t a setup el≈ëtt!
 */
function checkSheetAccess() {
  console.log('üîç Checking sheet access...');

  try {
    // 1. Pr√≥b√°ljuk megnyitni a spreadsheet-et
    console.log('üìÇ Trying to open spreadsheet with ID:', CONFIG.SHEET_ID);

    const spreadsheet = SpreadsheetApp.openById(CONFIG.SHEET_ID);
    console.log('‚úÖ Spreadsheet opened successfully');
    console.log('üìÑ Spreadsheet name:', spreadsheet.getName());

    // 2. List√°zzuk az √∂sszes sheet-et
    const sheets = spreadsheet.getSheets();
    console.log('üìã Available sheets:');
    sheets.forEach((sheet, index) => {
      console.log(`  ${index + 1}. ${sheet.getName()}`);
    });

    // 3. Pr√≥b√°ljuk megtal√°lni a target sheet-et
    let targetSheet = spreadsheet.getSheetByName(CONFIG.SHEET_NAME);

    if (targetSheet) {
      console.log('‚úÖ Target sheet found:', CONFIG.SHEET_NAME);
      const lastRow = targetSheet.getLastRow();
      console.log('üìä Current rows in sheet:', lastRow);
    } else {
      console.log('‚ö†Ô∏è  Target sheet NOT found:', CONFIG.SHEET_NAME);
      console.log('üîß Will need to create it');
    }

    return {
      success: true,
      spreadsheetName: spreadsheet.getName(),
      sheetExists: !!targetSheet,
      availableSheets: sheets.map(s => s.getName())
    };

  } catch (error) {
    console.error('‚ùå Error accessing spreadsheet:', error.toString());

    if (error.toString().includes('does not exist')) {
      console.error('üí° SOLUTION: Check the SHEET_ID in CONFIG. Make sure you have access to this spreadsheet.');
    } else if (error.toString().includes('permission')) {
      console.error('üí° SOLUTION: Make sure you have edit access to the spreadsheet.');
    }

    return {
      success: false,
      error: error.toString(),
      suggestion: 'Check SHEET_ID and permissions'
    };
  }
}

/**
 * M√ÅSODIK L√âP√âS: Futtasd ezt a sheet setup-hoz
 */
function setupSheetSafely() {
  console.log('üîß Safe sheet setup starting...');

  try {
    // El≈ësz√∂r ellen≈ërizz√ºk a hozz√°f√©r√©st
    const accessCheck = checkSheetAccess();

    if (!accessCheck.success) {
      throw new Error('Cannot access spreadsheet: ' + accessCheck.error);
    }

    console.log('üìÇ Opening spreadsheet...');
    const spreadsheet = SpreadsheetApp.openById(CONFIG.SHEET_ID);

    let sheet = spreadsheet.getSheetByName(CONFIG.SHEET_NAME);

    if (!sheet) {
      console.log('üìù Creating new sheet:', CONFIG.SHEET_NAME);

      // Biztons√°gos sheet l√©trehoz√°s
      sheet = spreadsheet.insertSheet();
      sheet.setName(CONFIG.SHEET_NAME);

      console.log('‚úÖ Sheet created successfully');
    } else {
      console.log('‚úÖ Using existing sheet:', CONFIG.SHEET_NAME);
    }

    // Ellen≈ërizz√ºk, hogy van-e header
    const lastRow = sheet.getLastRow();
    console.log('üìä Current last row:', lastRow);

    if (lastRow === 0) {
      console.log('üìã Setting up headers...');
      setupSheetHeadersSafely(sheet);
    } else {
      console.log('üìã Headers already exist, checking...');
      const firstRowValues = sheet.getRange(1, 1, 1, 5).getValues()[0];
      console.log('üìÑ Current headers:', firstRowValues);

      if (!firstRowValues[0] || firstRowValues[0] !== 'Timestamp') {
        console.log('üîÑ Headers seem incorrect, updating...');
        setupSheetHeadersSafely(sheet);
      }
    }

    console.log('‚úÖ Sheet setup completed successfully');
    return { success: true, sheetName: sheet.getName() };

  } catch (error) {
    console.error('üí• Error in setupSheetSafely:', error);
    return { success: false, error: error.toString() };
  }
}

/**
 * Biztons√°gos header setup
 */
function setupSheetHeadersSafely(sheet) {
  if (!sheet) {
    throw new Error('Sheet object is null or undefined');
  }

  console.log('üìã Setting up headers for sheet:', sheet.getName());

  const headers = [
    'Timestamp',
    'Name',
    'Email',
    'Social Link',
    'Why Choose',
    'Source',
    'UTM Source',
    'UTM Medium',
    'UTM Campaign',
    'UTM Term',
    'UTM Content',
    'User Agent',
    'Referrer',
    'Page URL'
  ];

  try {
    // Headers be√°ll√≠t√°sa
    const headerRange = sheet.getRange(1, 1, 1, headers.length);
    headerRange.setValues([headers]);

    // Form√°z√°s
    headerRange.setFontWeight('bold');
    headerRange.setBackground('#4285f4');
    headerRange.setFontColor('#ffffff');

    // Oszlopsz√©less√©gek
    sheet.setColumnWidth(1, 180); // Timestamp
    sheet.setColumnWidth(2, 150); // Name
    sheet.setColumnWidth(3, 200); // Email
    sheet.setColumnWidth(4, 200); // Social Link
    sheet.setColumnWidth(5, 300); // Why Choose

    // Header row befagyaszt√°sa
    sheet.setFrozenRows(1);

    console.log('‚úÖ Headers set successfully:', headers.length, 'columns');

  } catch (error) {
    console.error('‚ùå Error setting headers:', error);
    throw error;
  }
}

/**
 * F≈ë POST handler
 */
function doPost(e) {
  console.log('=== FORM SUBMISSION RECEIVED ===');

  try {
    // Log request details
    console.log('üì® Event object keys:', Object.keys(e));
    if (e.parameter) {
      console.log('üìã Parameters received:', JSON.stringify(e.parameter, null, 2));
    }

    // Extract form data
    let formData = {};

    if (e.parameter && Object.keys(e.parameter).length > 0) {
      formData = e.parameter;
      console.log('‚úÖ Using URL parameters');
    } else if (e.postData) {
      console.log('üì§ POST data type:', e.postData.type);

      if (e.postData.type === 'application/x-www-form-urlencoded') {
        const params = new URLSearchParams(e.postData.contents);
        for (const [key, value] of params) {
          formData[key] = value;
        }
        console.log('‚úÖ Using form-encoded data');
      }
    }

    console.log('üìä Final form data:', JSON.stringify(formData, null, 2));

    // Validate required fields
    if (!formData.name || !formData.email) {
      const error = `Missing required fields. Name: "${formData.name}", Email: "${formData.email}"`;
      console.log('‚ùå Validation failed:', error);
      return createResponse({
        status: 'error',
        message: error,
        received_data: formData
      });
    }

    // Safely access the spreadsheet
    console.log('üîç Accessing spreadsheet...');
    const spreadsheet = SpreadsheetApp.openById(CONFIG.SHEET_ID);

    if (!spreadsheet) {
      throw new Error('Could not open spreadsheet with ID: ' + CONFIG.SHEET_ID);
    }

    console.log('‚úÖ Spreadsheet opened:', spreadsheet.getName());

    let sheet = spreadsheet.getSheetByName(CONFIG.SHEET_NAME);

    // Create sheet if it doesn't exist
    if (!sheet) {
      console.log('üìù Creating sheet:', CONFIG.SHEET_NAME);
      sheet = spreadsheet.insertSheet();
      sheet.setName(CONFIG.SHEET_NAME);
      setupSheetHeadersSafely(sheet);
    }

    console.log('‚úÖ Using sheet:', sheet.getName());

    // Prepare data
    const timestamp = new Date();
    const rowData = [
      timestamp.toISOString(),
      formData.name || '',
      formData.email || '',
      formData.social_link || '',
      formData.why_choose || '',
      formData.source || 'landing_page',
      formData.utm_source || '',
      formData.utm_medium || '',
      formData.utm_campaign || '',
      formData.utm_term || '',
      formData.utm_content || '',
      formData.user_agent || '',
      formData.referrer || '',
      formData.page_url || ''
    ];

    console.log('üíæ Appending row data:', rowData);

    // Add the row
    const beforeRows = sheet.getLastRow();
    sheet.appendRow(rowData);
    const afterRows = sheet.getLastRow();

    console.log('üìä Rows before:', beforeRows, 'after:', afterRows);

    if (afterRows > beforeRows) {
      console.log('‚úÖ SUCCESS: Data written to sheet');

      return createResponse({
        status: 'success',
        message: 'Data saved successfully',
        timestamp: timestamp.toISOString(),
        row_number: afterRows,
        data: {
          name: formData.name,
          email: formData.email
        }
      });
    } else {
      throw new Error('Row was not added - appendRow failed');
    }

  } catch (error) {
    console.error('üí• ERROR in doPost:', error);
    console.error('üìç Error stack:', error.stack);

    return createResponse({
      status: 'error',
      message: error.toString(),
      timestamp: new Date().toISOString(),
      debug_info: {
        sheet_id: CONFIG.SHEET_ID,
        sheet_name: CONFIG.SHEET_NAME,
        error_stack: error.stack
      }
    });
  }
}

/**
 * GET handler for testing
 */
function doGet(e) {
  return createResponse({
    status: 'success',
    message: 'FindMate Waitlist API v3 is running',
    timestamp: new Date().toISOString(),
    config: CONFIG
  });
}

/**
 * Test function
 */
function testFormSubmissionSafe() {
  console.log('üß™ Testing form submission safely...');

  // El≈ësz√∂r ellen≈ërizz√ºk a sheet hozz√°f√©r√©st
  const accessCheck = checkSheetAccess();
  console.log('üîç Access check result:', accessCheck);

  if (!accessCheck.success) {
    console.error('‚ùå Cannot proceed with test - sheet access failed');
    return false;
  }

  // Ha OK, akkor tesztelj√ºk a form submission-t
  const testEvent = {
    parameter: {
      name: 'Test User Safe',
      email: 'test-safe@findmate.io',
      social_link: '@testsafe',
      why_choose: 'Testing the safe version!',
      source: 'test_safe_function'
    }
  };

  try {
    const result = doPost(testEvent);
    const response = JSON.parse(result.getContent());

    console.log('üéØ Test result:', JSON.stringify(response, null, 2));

    if (response.status === 'success') {
      console.log('‚úÖ TEST PASSED: Safe form submission working');
      return true;
    } else {
      console.log('‚ùå TEST FAILED:', response.message);
      return false;
    }
  } catch (error) {
    console.error('üí• TEST ERROR:', error);
    return false;
  }
}

/**
 * Response helper
 */
function createResponse(data) {
  return ContentService
    .createTextOutput(JSON.stringify(data, null, 2))
    .setMimeType(ContentService.MimeType.JSON);
}

/**
 * Manual sheet creation function
 */
function createSheetManually() {
  console.log('üîß Creating sheet manually...');

  try {
    const spreadsheet = SpreadsheetApp.openById(CONFIG.SHEET_ID);
    console.log('üìÇ Spreadsheet:', spreadsheet.getName());

    // Delete existing sheet if exists
    const existingSheet = spreadsheet.getSheetByName(CONFIG.SHEET_NAME);
    if (existingSheet) {
      console.log('üóëÔ∏è  Deleting existing sheet');
      spreadsheet.deleteSheet(existingSheet);
    }

    // Create new sheet
    const newSheet = spreadsheet.insertSheet();
    newSheet.setName(CONFIG.SHEET_NAME);

    console.log('üìù New sheet created:', newSheet.getName());

    // Setup headers
    setupSheetHeadersSafely(newSheet);

    console.log('‚úÖ Manual sheet creation completed');
    return { success: true, sheetName: newSheet.getName() };

  } catch (error) {
    console.error('‚ùå Manual creation failed:', error);
    return { success: false, error: error.toString() };
  }
}